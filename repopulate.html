<!DOCTYPE html>
<html>
<head>
    <script>
        /* Polyfill EventEmitter. */
        function EventEmitter() {
            this.listeners = {};
        };

        /**
         * @name Repopulate#on
         * @method
         * @param {string} event
         * @param {function} listener
         */
        EventEmitter.prototype.on = function (event, listener) {
            if (typeof this.listeners[event] !== 'object') {
                this.listeners[event] = [];
            }
            this.listeners[event].push(listener);
            return this;
        };

        EventEmitter.prototype.removeListener = function (event, listener) {
            let lis = this.listeners[event];
            if (!lis) return this;
            for(let i = lis.length; i > 0; i--) {
                if (lis[i] === listener) {
                    lis.splice(i,1);
                    break;
                }
            }
            return this;
        };

        EventEmitter.prototype.off = function (event, listener) {
            return this.removeListener(event, listener);
        };

        EventEmitter.prototype.emit = function (event) {
            let data= [], result, i, listeners, length, args = [].slice.call(arguments, 1);

            if (typeof this.listeners[event] === 'object') {
                listeners = this.listeners[event].slice();
                length = listeners.length;

                for (i = 0; i < length; i++) {
                    result = listeners[i].apply(this, args);
                    if(typeof result!== "undefined") data.push(result);
                }
                return data;
            }
        };

        EventEmitter.prototype.once = function (event, listener) {
            this.on(event, function g () {
                this.removeListener(event, g);
                listener.apply(this, arguments);
            });
        };



        /**
         *
         * @class Clase para poblar nested select
         * @constructor
         * @name Repopulate
         * @param {string|Object} selector
         */
        function Repopulate(selector) {
            this.root  =  (typeof selector === "object" )? selector : document.querySelector(selector);
            this.xhr_method= 'POST';
            this.listeners = {};
            this.emitter = new EventEmitter();
            if(this.root==null || this.root.tagName.toLowerCase()!=='select'){
                console.log('Tipo de selector equivocado "'+  selector +'", se esperaba "SELECT"');
            }
        }


        Repopulate.prototype.on = function (event, listener) {
            this.emitter.on(event, listener);
        };

        /**
         * @name Repopulate#bindAll
         * @method
         * @param {Object} element element type SELECT
         * @returns this
         */
        Repopulate.prototype.bindAll = function(element){
            let nodeItem, i=0,
                elem = element||this.root,
                $this = this,
                nodeList= document.querySelectorAll(elem.getAttribute('data-child')), //static NodeList
                addEvent = function(elem, child){
                    elem.addEventListener("change", function() {
                        $this.clearSelectors(child, true);

                        if(!elem.options[elem.selectedIndex].getAttribute('value')){
                            return;
                        }else{
                            $this.populateChild(child, elem.options[elem.selectedIndex].value)
                        }
                    });
                };

            for(; i<nodeList.length; i++)
            {
                nodeItem = nodeList[i];
                addEvent(elem, nodeItem);
                if (document.querySelectorAll(nodeItem.getAttribute('data-child')).length>0) this.bindAll(nodeItem);
            }

            return this;
        };

        /**
         * @name Repopulate#clearSelectors
         * @method
         * @param {Object} el element type SELECT
         * @param {boolean} deep
         * @returns this
         */
        Repopulate.prototype.clearSelectors = function(elem, deep){
            let i=0, nodeList, nodeItem;

            elem.options.length=0;

            if(deep){
                nodeList = document.querySelectorAll(elem.getAttribute('data-child'));
                for(; i<nodeList.length; i++)
                {
                    nodeItem = nodeList[i];
                    nodeItem.options.length=0;
                    if (document.querySelectorAll(nodeItem.getAttribute('data-child')).length>0) this.clearSelectors(nodeItem, true);
                }
            }
        };

        /**
         * @name Repopulate#populateChild
         * @method
         * @param {Object} el element type SELECT
         * @param {string} value get options by this value
         * @returns this
         */
        Repopulate.prototype.populateChild = function(elem, value){
            let attr = this.getDataAttr(elem),
                formdata= null
                $this = this,
                xhr = new XMLHttpRequest();

            if(this.xhr_method=='POST')
            {
                formdata= this.buildQueryPost(attr, value);
            }else{
                attr.url += this.buildQueryGet(attr, value);
            }

            xhr.open(this.xhr_method, attr.url, true);
            xhr.onload = function () {
                $this.setOptions(elem, $this.emitter.emit('ev.onLoadResponse', this, elem, attr)[0] || this.response, attr);
            };
            xhr.send(formdata);

            return this;
        };


        /**
         * Build a query string from an object of data
         * @param  {Object} data The data to turn into a query string
         * @return {String}      The query string
         */
        Repopulate.prototype.buildQueryGet = function(attr, value){
            let key,
                query = [],
                parameters = JSON.parse(attr.parameters)||{};

            parameters[attr.querykey]= value;

            for (key in parameters) query.push(encodeURIComponent(key) + '=' + encodeURIComponent(parameters[key]));

            return query.length? '?'+query.join('&') : null;
        };

        /**
         * Build Post Data
         * @param  {JSON} Object attributes
         * @param  {string} query value
         * @return {FormData} data to post
         */
        Repopulate.prototype.buildQueryPost = function(attr, value){
            let data = new FormData(), parameters = JSON.parse(attr.parameters)||{};

            data.append(attr.querykey, value);

            for (let key in parameters) data.append(key, parameters[key]);

            return data;
        };

        /**
         * @name Repopulate#setOptions
         * @method
         * @param {Object} el element type SELECT
         * @param {Array} data array({id: x, value:y},...)
         * @param {string|null} returnFormat string(key,value)
         * @returns this
         */
        Repopulate.prototype.setOptions = function(el, data, attr){
            if(!data.length) return;

            let keys= (typeof attr.returnFormat === "string")? attr.returnFormat.split(',') : [Object.keys(data[0])[0], Object.keys(data[0])[1]];

            if(attr.emptyOption){
                let option = document.createElement('option');
                option.text = attr.emptyOption;
                el.add(option);
            }

            for (let i = 0; i < data.length; i++) {
                let option = document.createElement('option');
                option.text = data[i][keys[0]];
                option.value = data[i][keys[1]];
                el.add(option);
            }
        };

        /**
         * @name Repopulate#getSelector
         * @method
         * @param {Object} el element type SELECT
         * @returns this
         */
        Repopulate.prototype.getDataAttr = function(el){
            return {
                url: el.getAttribute('data-url'), //url | window[json=VariableName] | function.call(this, parameter)
                querykey: el.getAttribute('data-querykey'),//if request: url?querykey=ParentSelectorValue
                parameters: el.getAttribute('data-parameters'),//json enconded parameters key=value
                child:el.getAttribute('data-child'),//
                emptyOption: el.getAttribute('data-emptyOption'),//string
                returnFormat: el.getAttribute('data-returnFormat'),//return format keys names "textName,valueName"
            };
        };

        document.addEventListener("DOMContentLoaded", function() {
            let repo = new Repopulate('#country');

            repo.on('ev.onLoadResponse', (data, el, attr)=>{
                return JSON.parse(data.response).out;//return corrent part of response
            });
            repo.xhr_method='GET';
            repo.bindAll(null);

        });



    </script>

</head>
<body>


<select id="country" data-child="#admin1, #admin11">
    <option value="">Seleccione país</option>
    <option value="es">España</option>
    <option value="au">Australia</option>
</select>


<select id="admin1" data-child="#admin2"
        data-url="{{ path('cave_backend_json_admin1') }}"
        data-querykey="countryid"
{#        data-returnformat="text,id"#}
        data-emptyOption="Seleccione admin1"
        data-parameters='{"format":"select2"}'#}
></select>

<select id="admin11"
        data-url="{{ path('cave_backend_json_admin1') }}"
        data-querykey="countryid"
        {#        data-returnformat="text,id"#}
        data-emptyOption="Seleccione admin1"
        data-parameters='{"format":"select2"}'#}
></select>



<select id="admin2" data-child="#admin3, #admin31, #admin32"
        data-url="{{ path('cave_backend_json_admin2') }}"
        data-querykey="admin1id"
        {#        data-returnformat="text,id"#}
        data-emptyOption="Seleccione admin2"
        {#        data-parameters='{"format":"select2"}'#}
></select>

<select id="admin3"
        data-url="{{ path('cave_backend_json_admin3') }}"
        data-querykey="admin2id"
        {#        data-returnformat="text,id"#}
        data-emptyOption="Seleccione admin3"
        {#        data-parameters='{"format":"select2"}'#}
></select>

<select id="admin31"
        data-url="{{ path('cave_backend_json_admin3') }}"
        data-querykey="admin2id"
        {#        data-returnformat="text,id"#}
        data-emptyOption="Seleccione admin3"
        {#        data-parameters='{"format":"select2"}'#}
></select>
<select id="admin32"
        data-url="{{ path('cave_backend_json_admin3') }}"
        data-querykey="admin2id"
        {#        data-returnformat="text,id"#}
        data-emptyOption="Seleccione admin3"
        {#        data-parameters='{"format":"select2"}'#}
></select>

</body>
</html>
